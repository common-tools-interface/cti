name: Build pipeline / workflow
on:
  push:
    branches:
      - 'master'
      - 'release/**'
  pull_request:
    branches:
      - 'master'
      - 'release/**'
      - 'feature/**'
      - 'bugfix/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      to_build:
        description: 'build on'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - rhel8_7
          - rhel8_8
          - sles15_sp4
          - sles15_sp5
          - sles15_sp5_aarch64

jobs:
  build_rhel87_x86_64:
    if: ${{ inputs.to_build == '' || inputs.to_build == 'all' || inputs.to_build == 'rhel8_7' }}
    uses: hpcde/devops-shared-workflows/.github/workflows/full_workflow.yaml@main
    with:
      runs-on-str: '["self-hosted", "vmSize:S", "arch:x86", "provider:gcp", "team:cdst", "build_rhel87_x86_64_${{github.run_id}}_${{github.run_attempt}}_${{github.actor}}_${{github.ref_name}}"]'
      build_targets: "rhel_8_7_x86_64"
    secrets: inherit

  build_rhel88_x86_64:
    if: ${{ inputs.to_build == '' || inputs.to_build == 'all' || inputs.to_build == 'rhel8_8' }}
    uses: hpcde/devops-shared-workflows/.github/workflows/full_workflow.yaml@main
    with:
      runs-on-str: '["self-hosted", "vmSize:S", "arch:x86", "provider:gcp", "team:cdst", "build_rhel88_x86_64_${{github.run_id}}_${{github.run_attempt}}_${{github.actor}}_${{github.ref_name}}"]'
      build_targets: "rhel_8_8_x86_64"
    secrets: inherit

  build_sles15_sp4_x86_64:
    if: ${{ inputs.to_build == '' || inputs.to_build == 'all' || inputs.to_build == 'sles15_sp4' }}
    uses: hpcde/devops-shared-workflows/.github/workflows/full_workflow.yaml@main
    with:
      runs-on-str: '["self-hosted", "vmSize:S", "arch:x86", "provider:gcp", "team:cdst", "build_sles15_sp4_x86_64_${{github.run_id}}_${{github.run_attempt}}_${{github.actor}}_${{github.ref_name}}"]'
      build_targets: "sles15_sp4_x86_64"
    secrets: inherit

  build_sles15_sp5_x86_64:
    if: ${{ inputs.to_build == '' || inputs.to_build == 'all' || inputs.to_build == 'sles15_sp5' }}
    uses: hpcde/devops-shared-workflows/.github/workflows/full_workflow.yaml@main
    with:
      runs-on-str: '["self-hosted", "vmSize:S", "arch:x86", "provider:gcp", "team:cdst", "build_sles15_sp5_x86_64_${{github.run_id}}_${{github.run_attempt}}_${{github.actor}}_${{github.ref_name}}"]'
      build_targets: "sles15_sp5_x86_64"
    secrets: inherit

  build_sles15_sp5_aarch64:
    if: ${{ inputs.to_build == '' || inputs.to_build == 'all' || inputs.to_build == 'sles15_sp5_aarch64' }}
    uses: hpcde/devops-shared-workflows/.github/workflows/full_workflow.yaml@main
    with:
      runs-on-str: '["self-hosted", "vmSize:S", "arch:arm", "provider:gcp", "team:cdst", "build_sles15_sp5_aarch64_${{github.run_id}}_${{github.run_attempt}}_${{github.actor}}_${{github.ref_name}}"]'
      build_targets: "sles15_sp5_aarch64"
    secrets: inherit
